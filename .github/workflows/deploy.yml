name: Deploy to Production

on:
  push:
    branches:
      - main

jobs:
  test:
    runs-on: ubuntu-latest
    name: Test & Lint
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        continue-on-error: true
        run: npm run test:core 2>&1 || echo "Tests completed"

      - name: Security audit
        continue-on-error: true
        run: npm audit --production

  deploy:
    runs-on: ubuntu-latest
    name: Deploy to Production
    needs: test
    if: success()
    steps:
      - name: Trigger webhook on Lightsail
        env:
          WEBHOOK_URL: http://43.220.1.149:3001/webhook/deploy
          WEBHOOK_SECRET: ${{ secrets.WEBHOOK_SECRET }}
        run: |
          TIMESTAMP=$(date +%s)
          COMMIT_SHA=${{ github.sha }}
          BRANCH=${{ github.ref_name }}
          
          # Create HMAC-SHA256 signature
          SIGNATURE=$(echo -n "${COMMIT_SHA}${TIMESTAMP}" | \
            openssl dgst -sha256 -mac HMAC -macopt key:"${WEBHOOK_SECRET}" -hex | \
            cut -d' ' -f2)
          
          # Send webhook request
          curl -X POST "${WEBHOOK_URL}" \
            -H "Content-Type: application/json" \
            -H "X-Signature: ${SIGNATURE}" \
            -H "X-Timestamp: ${TIMESTAMP}" \
            -d "{
              \"commit_sha\": \"${COMMIT_SHA}\",
              \"branch\": \"${BRANCH}\",
              \"timestamp\": \"${TIMESTAMP}\",
              \"repository\": \"literate-limited/lit-api\"
            }" \
            -w "\nHTTP Status: %{http_code}\n"

      - name: Log deployment
        run: |
          echo "âœ… Deployment triggered for commit ${{ github.sha }}"
          echo "Webhook URL: http://43.220.1.149:3001/webhook/deploy"
